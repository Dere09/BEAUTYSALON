<%- include('../partials/header', { title: 'Service List' , navActive: 'services' }) %>
  <%- include('../partials/sidebar', { path: '/service' }) %>

    <div class="main-content">
      <h2><i class="fas fa-boxes-packing"></i> Customers and Services</h2>

      <style>
        /* Content-specific styles */
        .content-box {
          background-color: white;
          border-radius: 8px;
          padding: 20px;
          box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        table {
          width: 100%;
          border-collapse: collapse;
        }

        table th,
        table td {
          padding: 12px;
          border-bottom: 1px solid #ccc;
          text-align: left;
        }

        table th {
          background-color: #fce4ec;
        }

        .actions a {
          margin-right: 10px;
          cursor: pointer;
        }

        .back-link {
          display: block;
          margin-bottom: 20px;
          color: #cc3366;
          text-decoration: none;
        }

        .back-link:hover {
          text-decoration: underline;
        }

        /* Modal Styles */
        .modal {
          display: none;
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background-color: rgba(0, 0, 0, 0.5);
          z-index: 9999;
          justify-content: center;
          align-items: center;
        }

        .modal-content {
          background: white;
          padding: 30px;
          border-radius: 10px;
          max-width: 500px;
          width: 90%;
        }

        .modal-content h3 {
          color: #e91e63;
          margin-bottom: 20px;
        }

        .modal-content label {
          font-weight: bold;
          margin-top: 10px;
          display: block;
        }

        .modal-content input,
        .modal-content select {
          width: 100%;
          padding: 10px;
          border-radius: 8px;
          border: 1px solid #ccc;
          margin-bottom: 15px;
        }

        .modal-content button {
          padding: 10px 20px;
          background-color: #e91e63;
          color: white;
          border: none;
          border-radius: 8px;
          margin-top: 10px;
          cursor: pointer;
        }
      </style>

      <div class="container">
        <a class="back-link" href="/Customers">&larr; Back to Customers</a>
      </div>

      <div class="content-box">
        <table class="table-hover table-sm" id="servicesTable">
          <thead>
            <tr>
              <th>OfferID</th>
              <th>Service</th>
              <th>Price</th>
              <th>RegID</th>
              <th>Assigned To</th>
              <th>Rank</th>
              <th>Status</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
            <% function escapeQuote(str) { return str ? str.replace(/'/g, "\\'" ) : "" ; } %>
              <% savedServices.forEach(function(lservice) { %>
                <tr>
                  <td>
                    <%= lservice.serviceOffID %>
                  </td>
                  <td>
                    <%= lservice.serviceName %>
                  </td>
                  <td>
                    <%= lservice.servicePrice %>
                  </td>
                  <td>
                    <%= lservice.registrationId %>
                  </td>
                  <td>
                    <%= lservice.assignedemployee %>
                  </td>
                  <td>
                    <%= lservice.percentage || '0.0' %>%
                  </td>
                  <td>
                    <span class="badge <%= lservice.status === 'Completed' ? 'bg-success' : 'bg-warning' %>">
                      <%= lservice.status %>
                    </span>
                  </td>
                  <td class="actions">
                    <a onclick="openEditModal('<%= lservice.serviceOffID %>', '<%= escapeQuote(lservice.serviceName) %>', '<%= lservice.status %>', '<%= lservice.servicePrice %>')"
                      title="Edit Status">
                      <i class="fas fa-edit" style="color:#ffc107;"></i>
                    </a>
                  </td>
                </tr>
                <% }); %>
          </tbody>
        </table>

        <nav aria-label="Page navigation" style="margin-top: 20px;">
          <ul class="pagination justify-content-center" id="pagination"></ul>
        </nav>
      </div>
    </div>

    <!-- Edit Modal -->
    <div id="editModal" class="modal">
      <div class="modal-content">
        <h3><i class="fas fa-edit"></i> Edit Service Status</h3>
        <form id="editForm" method="POST">
          <input type="hidden" name="serviceOffId" id="editServiceOffId">
          <label>Service Name</label>
          <input type="text" id="editserviceName" readonly>
          <label>Status</label>
          <select name="status" id="editstatus">
            <option value="New">New</option>
            <option value="In Progress">In Progress</option>
            <option value="Completed">Completed</option>
          </select>
          <button type="submit">Save Changes</button>
          <button type="button" onclick="closeModal('editModal')">Cancel</button>
        </form>
      </div>
    </div>

    <script>
      function openEditModal(serviceOffId, serviceName, status, Amount) {
        document.getElementById('editForm').action = `/editServiceStatus/${serviceOffId}?_method=PUT`;
        document.getElementById('editServiceOffId').value = serviceOffId;
        document.getElementById('editserviceName').value = serviceName;
        document.getElementById('editstatus').value = status;
        document.getElementById('editModal').style.display = 'flex';
      }

      function closeModal(id) {
        document.getElementById(id).style.display = 'none';
      }

      document.addEventListener('keydown', function (e) {
        if (e.key === "Escape") {
          closeModal('editModal');
        }
      });

      // Pagination script
      const rowsPerPage = 10;
      const rows = document.querySelectorAll("#servicesTable tbody tr");
      const pagination = document.getElementById("pagination");

      function showPage(page) {
        const start = (page - 1) * rowsPerPage;
        const end = start + rowsPerPage;

        rows.forEach((row, index) => {
          row.style.display = (index >= start && index < end) ? "" : "none";
        });

        pagination.innerHTML = "";
        const pageCount = Math.ceil(rows.length / rowsPerPage);
        for (let i = 1; i <= pageCount; i++) {
          const li = document.createElement("li");
          li.className = "page-item" + (i === page ? " active" : "");
          li.innerHTML = `<a class="page-link" href="#">${i}</a>`;
          li.addEventListener("click", function (e) {
            e.preventDefault();
            showPage(i);
          });
          pagination.appendChild(li);
        }
      }

      if (rows.length > 0) {
        showPage(1);
      }
    </script>

    <%- include('../partials/footer') %>