<%- include('../partials/header', { title: 'Service List' , navActive: 'services' }) %>
  <%- include('../partials/sidebar', { path: '/service' }) %>

    <div class="main-content">
      <h2><i class="fas fa-boxes-packing"></i> Customers and Services</h2>

      <style>
        /* Content-specific styles */
        .content-box {
          background-color: white;
          border-radius: 8px;
          padding: 20px;
          box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        table {
          width: 100%;
          border-collapse: collapse;
        }

        table th,
        table td {
          padding: 12px;
          border-bottom: 1px solid #ccc;
          text-align: left;
        }

        table th {
          background-color: #fce4ec;
        }

        .actions a {
          margin-right: 10px;
          cursor: pointer;
        }

        .back-link {
          display: block;
          margin-bottom: 20px;
          color: #cc3366;
          text-decoration: none;
        }

        .back-link:hover {
          text-decoration: underline;
        }

        /* Modal Styles */
        .modal {
          display: none;
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background-color: rgba(0, 0, 0, 0.5);
          z-index: 9999;
          justify-content: center;
          align-items: center;
        }

        .modal-content {
          background: white;
          padding: 30px;
          border-radius: 10px;
          max-width: 500px;
          width: 90%;
        }

        .modal-content h3 {
          color: #e91e63;
          margin-bottom: 20px;
        }

        .modal-content label {
          font-weight: bold;
          margin-top: 10px;
          display: block;
        }

        .modal-content input,
        .modal-content select {
          width: 100%;
          padding: 10px;
          border-radius: 8px;
          border: 1px solid #ccc;
          margin-bottom: 15px;
        }

        .modal-content button {
          padding: 10px 20px;
          background-color: #e91e63;
          color: white;
          border: none;
          border-radius: 8px;
          margin-top: 10px;
          cursor: pointer;
        }

        /* Standard Pagination Styles */
        .pagination-container {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-top: 30px;
          padding-top: 20px;
          border-top: 1px solid #f0f0f0;
        }

        .pagination-controls {
          display: flex;
          gap: 8px;
        }

        .pagination-btn {
          text-decoration: none;
          padding: 8px 16px;
          border: 1px solid #e0e0e0;
          border-radius: 8px;
          color: #555;
          background: white;
          transition: all 0.2s;
          font-weight: 600;
          display: inline-flex;
          align-items: center;
          justify-content: center;
        }

        .pagination-btn:hover {
          background-color: #fff5f8;
          border-color: #cc3366;
          color: #cc3366;
        }

        .pagination-btn.active {
          background-color: #cc3366;
          border-color: #cc3366;
          color: white;
        }
      </style>

      <div class="container"
        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <a class="back-link" href="/Customers" style="margin-bottom: 0;">&larr; Back to Customers</a>
        <button id="batchCompleteBtn" class="btn btn-primary"
          style="display: none; background-color: #28a745; border: none; padding: 8px 16px; border-radius: 20px; color: white; font-weight: bold;">
          <i class="fas fa-check-double"></i> Mark Selected as Completed
        </button>
      </div>

      <div class="content-box">
        <table class="table-hover table-sm" id="servicesTable">
          <thead>
            <tr>
              <th><input type="checkbox" id="selectAll"></th>
              <th>OfferID</th>
              <th>Service</th>
              <th>Price</th>
              <th>RegID</th>
              <th>Assigned To</th>
              <th>Rank</th>
              <th>Status</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
            <% function escapeQuote(str) { return str ? str.replace(/'/g, "\\'" ) : "" ; } %>
              <% savedServices.forEach(function(lservice) { %>
                <tr>
                  <td>
                    <input type="checkbox" class="service-checkbox" value="<%= lservice.serviceOffID %>">
                  </td>
                  <td>
                    <%= lservice.serviceOffID %>
                  </td>
                  <td>
                    <%= lservice.serviceName %>
                  </td>
                  <td>
                    <%= lservice.servicePrice %>
                  </td>
                  <td>
                    <%= lservice.registrationId %>
                  </td>
                  <td>
                    <%= lservice.assignedemployee %>
                  </td>
                  <td>
                    <%= lservice.percentage || '0.0' %>%
                  </td>
                  <td>
                    <span class="badge <%= lservice.status === 'Completed' ? 'bg-success' : 'bg-warning' %>">
                      <%= lservice.status %>
                    </span>
                  </td>
                  <td class="actions">
                    <% if (lservice.status !=='Completed' ) { %>
                      <form action="/editServiceStatus/<%= lservice.serviceOffID %>" method="POST"
                        style="display: inline;">
                        <input type="hidden" name="status" value="Completed">
                        <button type="submit" style="background: none; border: none; padding: 0; cursor: pointer;"
                          title="Mark as Completed">
                          <i class="fas fa-check-circle" style="color:#28a745;"></i>
                        </button>
                      </form>
                      <% } %>
                        <a onclick="openEditModal('<%= lservice.serviceOffID %>', '<%= escapeQuote(lservice.serviceName) %>', '<%= lservice.status %>', '<%= lservice.servicePrice %>')"
                          title="Edit Status">
                          <i class="fas fa-edit" style="color:#ffc107;"></i>
                        </a>
                  </td>
                </tr>
                <% }); %>
          </tbody>
        </table>

        <!-- Standard Pagination -->
        <% if (totalPages> 0) { %>
          <div class="pagination-container">
            <span style="color: #666; font-size: 14px;">
              Showing page <strong>
                <%= currentPage %>
              </strong> of <strong>
                <%= totalPages %>
              </strong>
            </span>
            <div class="pagination-controls">
              <% if (currentPage> 1) { %>
                <a href="?page=<%= currentPage - 1 %>" class="pagination-btn">
                  <i class="fas fa-chevron-left"></i> Previous
                </a>
                <% } %>

                  <% for(let i=1; i <=totalPages; i++) { %>
                    <a href="?page=<%= i %>" class="pagination-btn <%= currentPage === i ? 'active' : '' %>">
                      <%= i %>
                    </a>
                    <% } %>

                      <% if (currentPage < totalPages) { %>
                        <a href="?page=<%= currentPage + 1 %>" class="pagination-btn">
                          Next <i class="fas fa-chevron-right"></i>
                        </a>
                        <% } %>
            </div>
          </div>
          <% } %>
      </div>
    </div>

    <!-- Edit Modal -->
    <div id="editModal" class="modal">
      <div class="modal-content">
        <h3><i class="fas fa-edit"></i> Edit Service Status</h3>
        <form id="editForm" method="POST">
          <input type="hidden" name="serviceOffId" id="editServiceOffId">
          <label>Service Name</label>
          <input type="text" id="editserviceName" readonly>
          <label>Status</label>
          <select name="status" id="editstatus">
            <option value="New">New</option>
            <option value="In Progress">In Progress</option>
            <option value="Completed">Completed</option>
          </select>
          <button type="submit">Save Changes</button>
          <button type="button" onclick="closeModal('editModal')">Cancel</button>
        </form>
      </div>
    </div>

    <script>
      function openEditModal(serviceOffId, serviceName, status, Amount) {
        document.getElementById('editForm').action = `/editServiceStatus/${serviceOffId}?_method=PUT`;
        document.getElementById('editServiceOffId').value = serviceOffId;
        document.getElementById('editserviceName').value = serviceName;
        document.getElementById('editstatus').value = status;
        document.getElementById('editModal').style.display = 'flex';
      }

      function closeModal(id) {
        document.getElementById(id).style.display = 'none';
      }

      document.addEventListener('keydown', function (e) {
        if (e.key === "Escape") {
          closeModal('editModal');
        }
      });

      // Batch Selection Script
      const selectAll = document.getElementById('selectAll');
      const checkboxes = document.querySelectorAll('.service-checkbox');
      const batchBtn = document.getElementById('batchCompleteBtn');

      function updateBatchBtn() {
        const checkedCount = document.querySelectorAll('.service-checkbox:checked').length;
        batchBtn.style.display = checkedCount > 0 ? 'inline-block' : 'none';
      }

      selectAll.addEventListener('change', function () {
        checkboxes.forEach(cb => cb.checked = this.checked);
        updateBatchBtn();
      });

      checkboxes.forEach(cb => {
        cb.addEventListener('change', updateBatchBtn);
      });

      batchBtn.addEventListener('click', function () {
        const selectedIDs = Array.from(document.querySelectorAll('.service-checkbox:checked')).map(cb => cb.value);
        if (selectedIDs.length === 0) return;

        if (confirm(`Mark ${selectedIDs.length} services as Completed?`)) {
          const form = document.createElement('form');
          form.method = 'POST';
          form.action = '/batchUpdateStatus';

          const input = document.createElement('input');
          input.type = 'hidden';
          input.name = 'serviceOffIDs';
          input.value = JSON.stringify(selectedIDs); // Send as stringified array or multiple inputs

          // Actually, let's send multiple hidden inputs for better express handling
          selectedIDs.forEach(id => {
            const idInput = document.createElement('input');
            idInput.type = 'hidden';
            idInput.name = 'serviceOffIDs[]';
            idInput.value = id;
            form.appendChild(idInput);
          });

          document.body.appendChild(form);
          form.submit();
        }
      });
    </script>

    <%- include('../partials/footer') %>